{% extends "base.html" %}

{% block content %}
<h2>Lista de Vendas</h2>

<!-- Gráfico de Vendas -->
<div class="mb-5">
    <canvas id="vendasChart" width="400" height="200"></canvas>
</div>

<!-- Tabela de Vendas -->
<table class="table table-striped">
    <thead>
        <tr>
            <th>ID</th>
            <th>Produto</th>
            <th>Quantidade Vendida</th>
            <th>Valor Total</th>
            <th>Data da Venda</th>
        </tr>
    </thead>
    <tbody>
        {% for venda in vendas %}
        <tr>
            <td>{{ venda['id'] }}</td>
            <td>{{ venda['produto_nome'] }}</td>
            <td>{{ venda['quantidade_vendida'] }}</td>
            <td>R$ {{ venda['valor_venda'] }}</td>
            <td>{{ venda['data_venda'] }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
<a href="/" class="btn btn-secondary">Voltar</a>

<!-- Scripts para o Gráfico -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Dados para o gráfico (convertidos para JSON no lado do servidor)
        const chartLabels = JSON.parse('{{ vendas|map(attribute="produto_nome")|list|tojson|safe }}');
        const quantidadeDataset = JSON.parse('{{ vendas|map(attribute="quantidade_vendida")|list|tojson|safe }}');
        const valorDataset = JSON.parse('{{ vendas|map(attribute="valor_venda")|list|tojson|safe }}');
    
        // Gráfico de vendas
        const ctx = document.getElementById('vendasChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar', // Tipo de gráfico: barras
            data: {
                labels: chartLabels,
                datasets: [
                    {
                        label: 'Quantidade Vendida',
                        data: quantidadeDataset,
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Valor Total (R$)',
                        data: valorDataset,
                        backgroundColor: 'rgba(153, 102, 255, 0.2)',
                        borderColor: 'rgba(153, 102, 255, 1)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                if (context.dataset.label === 'Valor Total (R$)') {
                                    return `${context.dataset.label}: R$ ${context.raw.toFixed(2)}`;
                                }
                                return `${context.dataset.label}: ${context.raw}`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Valores'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Produtos'
                        }
                    }
                }
            }
        });
    });
</script>    
{% endblock %}
